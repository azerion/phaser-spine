/*!
 * phaser-spine - version 4.0.0-alpha1 
 * Spine plugin for Phaser.io!
 *
 * OrangeGames
 * Build at 22-11-2017
 * Released under MIT License 
 */

var __extends=this&&this.__extends||function(){var a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(a,b){a.__proto__=b}||function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])};return function(b,c){function d(){this.constructor=b}a(b,c),b.prototype=null===c?Object.create(c):(d.prototype=c.prototype,new d)}}(),PhaserSpine;!function(a){var b;!function(b){var c=function(){function b(a){this.vertices=spine.Utils.newFloatArray(8192),this.tempColor=new spine.Color,this.game=a}return b.prototype.destroy=function(){this.game=null,this.vertices=null,this.tempColor=null},b.prototype.resize=function(a,b,c){var d=c.resolution;c.context.resetTransform(),c.context.scale(b.x*d,b.y*d),c.context.translate(a.width/2/b.x,a.height/b.y/d),d>1&&c.context.translate(0,a.height/b.y/d/2),c.context.translate(a.x/b.x,a.y/b.y)},b.prototype.drawImages=function(b,c){var d=c.context,e=b.skeleton.drawOrder,f=c.resolution;a.SpinePlugin.DEBUG&&(d.strokeStyle="green"),d.save();for(var g=0,h=e.length;g<h;g++){var i=e[g],j=i.getAttachment(),k=null,l=null,m=null;if(j instanceof spine.RegionAttachment){k=j,l=k.region,m=l.texture.getImage();var n=i.bone.skeleton,o=n.color,p=i.color,q=k.color,r=o.a*p.a*q.a,s=this.tempColor;s.set(o.r*p.r*q.r,o.g*p.g*q.g,o.b*p.b*q.b,r);var t=j,u=i.bone,v=l.width,w=l.height;d.save(),d.transform(u.a,u.c,u.b,u.d,u.worldX,u.worldY),d.translate(j.offset[0],j.offset[1]),d.rotate(j.rotation*Math.PI/180);var x=t.width/v;if(d.scale(x*j.scaleX,x*j.scaleY),d.translate(v/2,w/2),j.region.rotate){var y=v;v=w,w=y,d.rotate(-Math.PI/2)}d.scale(1,-1),d.translate(-v/2/f,-w/2/f),1==s.r&&1==s.g&&1==s.b&&1==s.a||(d.globalAlpha=s.a),d.drawImage(m,l.x,l.y,v,w,0,0,v/f,w/f),a.SpinePlugin.DEBUG&&d.strokeRect(0,0,v/f,w/f),d.restore()}}d.restore()},b.prototype.drawTriangles=function(c,d){for(var e=null,f=null,g=null,h=c.skeleton.drawOrder,i=d.resolution,j=0,k=h.length;j<k;j++){var l=h[j],m=l.getAttachment(),n=null,o=null;if(m instanceof spine.RegionAttachment){var p=m;f=this.computeRegionVertices(l,p,!1),g=b.QUAD_TRIANGLES,o=p.region,n=o.texture.getImage()}else{if(!(m instanceof spine.MeshAttachment))continue;var q=m;f=this.computeMeshVertices(l,q,!1),g=q.triangles,n=q.region.renderObject.texture.getImage()}if(null!=n){var r=l.data.blendMode;r!=e&&(e=r);for(var s=d.context,t=0;t<g.length;t+=3){var u=8*g[t],v=8*g[t+1],w=8*g[t+2],x=f[u],y=f[u+1],z=f[u+6],A=f[u+7],B=f[v],C=f[v+1],D=f[v+6],E=f[v+7],F=f[w],G=f[w+1],H=f[w+6],I=f[w+7];this.drawTriangle(d,n,x/i,y/i,z,A,B/i,C/i,D,E,F/i,G/i,H,I),a.SpinePlugin.DEBUG&&(s.strokeStyle="green",s.beginPath(),s.moveTo(x/i,y/i),s.lineTo(B/i,C/i),s.lineTo(F/i,G/i),s.lineTo(x/i,y/i),s.stroke())}}}},b.prototype.drawTriangle=function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o=a.context;e*=b.width,f*=b.height,i*=b.width,j*=b.height,m*=b.width,n*=b.height,o.beginPath(),o.moveTo(c,d),o.lineTo(g,h),o.lineTo(k,l),o.closePath(),g-=c,h-=d,k-=c,l-=d,i-=e,j-=f,m-=e,n-=f;var p=1/(i*n-m*j),q=(n*g-j*k)*p,r=(n*h-j*l)*p,s=(i*k-m*g)*p,t=(i*l-m*h)*p,u=c-q*e-s*f,v=d-r*e-t*f;o.save(),o.transform(q,r,s,t,u,v),o.clip(),o.drawImage(b,0,0),o.restore()},b.prototype.computeRegionVertices=function(a,c,d){var e=a.bone.skeleton,f=e.color,g=a.color,h=c.color,i=f.a*g.a*h.a,j=d?i:1,k=this.tempColor;k.set(f.r*g.r*h.r*j,f.g*g.g*h.g*j,f.b*g.b*h.b*j,i),c.computeWorldVertices(a.bone,this.vertices,0,b.VERTEX_SIZE);var l=this.vertices,m=c.uvs;return l[spine.RegionAttachment.C1R]=k.r,l[spine.RegionAttachment.C1G]=k.g,l[spine.RegionAttachment.C1B]=k.b,l[spine.RegionAttachment.C1A]=k.a,l[spine.RegionAttachment.U1]=m[0],l[spine.RegionAttachment.V1]=m[1],l[spine.RegionAttachment.C2R]=k.r,l[spine.RegionAttachment.C2G]=k.g,l[spine.RegionAttachment.C2B]=k.b,l[spine.RegionAttachment.C2A]=k.a,l[spine.RegionAttachment.U2]=m[2],l[spine.RegionAttachment.V2]=m[3],l[spine.RegionAttachment.C3R]=k.r,l[spine.RegionAttachment.C3G]=k.g,l[spine.RegionAttachment.C3B]=k.b,l[spine.RegionAttachment.C3A]=k.a,l[spine.RegionAttachment.U3]=m[4],l[spine.RegionAttachment.V3]=m[5],l[spine.RegionAttachment.C4R]=k.r,l[spine.RegionAttachment.C4G]=k.g,l[spine.RegionAttachment.C4B]=k.b,l[spine.RegionAttachment.C4A]=k.a,l[spine.RegionAttachment.U4]=m[6],l[spine.RegionAttachment.V4]=m[7],l},b.prototype.computeMeshVertices=function(a,c,d){var e=a.bone.skeleton,f=e.color,g=a.color,h=c.color,i=f.a*g.a*h.a,j=d?i:1,k=this.tempColor;k.set(f.r*g.r*h.r*j,f.g*g.g*h.g*j,f.b*g.b*h.b*j,i);var l=c.worldVerticesLength/2;this.vertices.length<c.worldVerticesLength&&(this.vertices=spine.Utils.newFloatArray(c.worldVerticesLength));var m=this.vertices;c.computeWorldVertices(a,0,c.worldVerticesLength,m,0,b.VERTEX_SIZE);for(var n=c.uvs,o=0,p=l,q=0,r=2;o<p;o++)m[r++]=k.r,m[r++]=k.g,m[r++]=k.b,m[r++]=k.a,m[r++]=n[q++],m[r++]=n[q++],r+=2;return m},b.QUAD_TRIANGLES=[0,1,2,2,3,0],b.VERTEX_SIZE=8,b}();b.Renderer=c}(b=a.Canvas||(a.Canvas={}))}(PhaserSpine||(PhaserSpine={}));var PhaserSpine;!function(a){var b;!function(a){var b=function(a){function b(b){return a.call(this,b)||this}return __extends(b,a),b.prototype.setFilters=function(a,b){},b.prototype.setWraps=function(a,b){},b.prototype.dispose=function(){},b}(spine.Texture);a.Texture=b}(b=a.Canvas||(a.Canvas={}))}(PhaserSpine||(PhaserSpine={}));var PhaserSpine;!function(a){var b=function(b){function c(a,c){return b.call(this,a,c)||this}return __extends(c,b),c.prototype.init=function(a){void 0===a&&(a={}),c.DEBUG=a.debugRendering||!1,c.TRIANGLE=a.triangleRendering||!1,this.addSpineCache(),this.addSpineFactory(),this.addSpineLoader()},c.prototype.addSpineLoader=function(){Phaser.Loader.prototype.spine=function(a,b,d){var e=this,f=b.substr(0,b.lastIndexOf(".")),g=b.substr(0,b.lastIndexOf("/")),h=b.substring(b.lastIndexOf("/")+1,b.lastIndexOf("."));this.text("atlas_"+c.SPINE_NAMESPACE+"_"+a,f+".atlas"),this.json(c.SPINE_NAMESPACE+a,f+".json"),this.onFileComplete.add(function(b,c){if(0===c.indexOf("atlas_spine_")){var d=e.game.cache.getText(c),f=null;d.split(/\r\n|\r|\n/).forEach(function(b,d){0!==b.length&&b.indexOf(":")===-1&&(null===f&&(f=b.substr(0,b.lastIndexOf("."))),null!==f&&b.indexOf(f)!==-1&&b.indexOf(".")!==-1&&(h!==c.replace("atlas_spine_","")&&a!==c.replace("atlas_spine_","")||this.image(b,g+"/"+b)))}.bind(e))}})}},c.prototype.addSpineFactory=function(){Phaser.GameObjectFactory.prototype.spine=function(b,c,d,e,f,g){void 0===e&&(e=!1),void 0===g&&(g=this.world);var h=new a.Spine(this.game,b,c,d,e);return g.add(h)},Phaser.GameObjectCreator.prototype.spine=function(b,c,d,e,f,g){return void 0===e&&(e=!1),new a.Spine(this.game,b,c,d,e)}},c.prototype.addSpineCache=function(){Phaser.Cache.prototype.spine={},Phaser.Cache.prototype.addSpine=function(a,b){this.spine[a]=b},Phaser.Cache.prototype.getSpine=function(a){return this.spine.hasOwnProperty(a)||console.warn('Phaser.Cache.getSpine: Key "'+a+'" not found in Cache.'),this.spine[a]}},c.RESOLUTION_REGEXP=/@(.+)x/,c.SPINE_NAMESPACE="spine",c.DEBUG=!1,c.TRIANGLE=!1,c}(Phaser.Plugin);a.SpinePlugin=b}(PhaserSpine||(PhaserSpine={})),Phaser.Rope.prototype.postUpdate=function(){};var PhaserSpine;!function(a){var b=function(b){function c(c,d,e,f,g){void 0===g&&(g=!1);var h=b.call(this,c,d,e,"")||this;h.premultipliedAlpha=!1,h.premultipliedAlpha=g,h.skeleton=h.createSkeleton(f),h.skeleton.flipY=h.game.renderType===Phaser.CANVAS,h.skeleton.setToSetupPose(),h.skeleton.updateWorldTransform();var i=new spine.Vector2;h.skeleton.getBounds(new spine.Vector2,i,[]),h.texture.setFrame(new PIXI.Rectangle(0,0,i.x,i.y)),h.skeleton.setToSetupPose(),h.skeleton.updateWorldTransform();var j=new spine.Vector2,i=new spine.Vector2;return h.skeleton.getBounds(j,i,[]),h.specialBounds=new PIXI.Rectangle(j.x,j.y,i.x,i.y),h.stateData=new spine.AnimationStateData(h.skeleton.data),h.state=new spine.AnimationState(h.stateData),h.onEvent=new Phaser.Signal,h.onComplete=new Phaser.Signal,h.onEnd=new Phaser.Signal,h.onInterrupt=new Phaser.Signal,h.onStart=new Phaser.Signal,h.onDispose=new Phaser.Signal,h.state.addListener({interrupt:h.onInterrupt.dispatch.bind(h.onInterrupt),dispose:h.onDispose.dispatch.bind(h.onDispose),event:h.onEvent.dispatch.bind(h.onEvent),complete:h.onComplete.dispatch.bind(h.onComplete),start:h.onStart.dispatch.bind(h.onStart),end:h.onEnd.dispatch.bind(h.onEnd)}),h.game.renderType===Phaser.CANVAS?h.renderer=new a.Canvas.Renderer(h.game):h.renderer=new a.WebGL.Renderer(h.game),h}return __extends(c,b),c.prototype.destroy=function(a){b.prototype.destroy.call(this,a),null===this.game||this.destroyPhase||(this.specialBounds=null,this.renderer&&(this.renderer.destroy(),this.renderer=null),this.onEvent&&(this.onEvent.dispose(),this.onEvent=null,this.onStart.dispose(),this.onStart=null,this.onInterrupt.dispose(),this.onInterrupt=null,this.onDispose.dispose(),this.onDispose=null,this.onComplete.dispose(),this.onComplete=null,this.onEnd.dispose(),this.onEnd=null),this.state&&(this.state.clearListeners(),this.state=null,this.stateData=null))},c.prototype.createSkeleton=function(b){var c=this,d=new spine.TextureAtlas(this.game.cache.getText("atlas_"+a.SpinePlugin.SPINE_NAMESPACE+"_"+b),function(b,d){if(c.game.renderType===Phaser.CANVAS)return new a.Canvas.Texture(c.game.cache.getImage(b));var e=0!==d.min.toLowerCase().indexOf("mip");return new a.WebGL.Texture(c.game.renderer.gl,c.game.cache.getImage(b),e)}),e=new spine.AtlasAttachmentLoader(d),f=new spine.SkeletonJson(e),g=f.readSkeletonData(this.game.cache.getJSON(a.SpinePlugin.SPINE_NAMESPACE+b));return new spine.Skeleton(g)},c.prototype.update=function(){b.prototype.update.call(this),this.state.update(this.game.time.elapsed/1e3),this.state.apply(this.skeleton),this.skeleton.color.a=this.worldAlpha,this.skeleton.getRootBone().rotation=180*this.worldRotation/Math.PI,this.skeleton.updateWorldTransform()},c.prototype._renderCanvas=function(b,c){this.visible&&this.alive&&(this.renderer.resize(this.getBounds(),this.scale,b),a.SpinePlugin.TRIANGLE?this.renderer.drawTriangles(this,b):this.renderer.drawImages(this,b))},c.prototype._renderWebGL=function(a,b){this.visible&&this.alive&&(this.renderer.resize(this,this.getBounds(),this.scale,a),this.renderer.draw(this,a,this.premultipliedAlpha))},c.prototype.setMixByName=function(a,b,c){this.stateData.setMix(a,b,c)},c.prototype.setAnimationByName=function(a,b,c){return void 0===c&&(c=!1),this.state.setAnimation(a,b,c)},c.prototype.addAnimationByName=function(a,b,c,d){return void 0===c&&(c=!1),void 0===d&&(d=0),this.state.addAnimation(a,b,c,d)},c.prototype.getCurrentAnimationForTrack=function(a){return this.state.tracks[a]&&this.state.tracks[a].animation?this.state.tracks[a].animation.name:(console.warn("No animation found on track index: ",a),"")},c.prototype.setSkinByName=function(a){var b=this.skeleton.data.findSkin(a);return b?void this.skeleton.setSkin(b):void console.warn("Skin not found: "+a)},c.prototype.setSkin=function(a){this.skeleton.setSkin(a)},c.prototype.setToSetupPose=function(){this.skeleton.setToSetupPose()},c.prototype.createCombinedSkin=function(a){for(var b=[],c=1;c<arguments.length;c++)b[c-1]=arguments[c];if(0===b.length)return void console.warn("Unable to combine skins when no skins are passed...");for(var d=new spine.Skin(a),e=0;e<b.length;e++){var f=b[e],g=this.skeleton.data.findSkin(f);if(!g)return void console.warn("Skin not found: "+f);for(var h in g.attachments){var i=h.split(":"),j=parseInt(i[0]),k=Object.keys(g.attachments[h])[0],l=g.attachments[h][k];if(void 0===j||void 0===k)return void console.warn("something went wrong with reading the attachments index and/or name");d.addAttachment(j,k,l)}}return this.skeleton.data.skins.push(d),d},c}(Phaser.Sprite);a.Spine=b}(PhaserSpine||(PhaserSpine={}));var PhaserSpine;!function(a){var b;!function(b){var c=function(){function b(a){this.mvp=new spine.webgl.Matrix4,this.game=a;var b=this.game.renderer.renderSession.gl;this.shader=spine.webgl.Shader.newTwoColoredTextured(b),this.batcher=new spine.webgl.PolygonBatcher(b),this.mvp.ortho2d(0,0,this.game.width-1,this.game.height-1),this.skeletonRenderer=new spine.webgl.SkeletonRenderer(b),this.debugRenderer=new spine.webgl.SkeletonDebugRenderer(b),this.debugRenderer.drawRegionAttachments=!1,this.debugRenderer.drawBoundingBoxes=!1,this.debugRenderer.drawMeshHull=!1,this.debugRenderer.drawMeshTriangles=!1,this.debugRenderer.drawPaths=!1,this.debugShader=spine.webgl.Shader.newColored(b),this.shapes=new spine.webgl.ShapeRenderer(b)}return b.prototype.destroy=function(){this.shader.dispose(),this.batcher.dispose(),this.debugShader.dispose(),this.shapes.dispose(),this.game=null,this.shader=null,this.debugShader=null,this.batcher=null,this.shapes=null,this.skeletonRenderer=null,this.debugRenderer=null},b.prototype.resize=function(a,b,c,d){var e=this.game.width,f=this.game.height,g=d.resolution;a.skeleton.flipX=c.x<0,a.skeleton.flipY=c.y<0;var h=Math.max(c.x,c.y),i=e/h,j=f/h,k=-b.centerX,l=(-f+b.centerY)*g+b.height/2,m=k/h,n=l/h;this.mvp.ortho2d(m*g,n,i*g,j*g),d.gl.viewport(0,0,e*g,f*g)},b.prototype.draw=function(b,c,d){c.spriteBatch.end();for(var e=c.blendModeManager.currentBlendMode,f=c.shaderManager.currentShader,g=0;g<c.shaderManager.attribState.length;g++)c.shaderManager.attribState[g]=null,c.gl.disableVertexAttribArray(g);this.shader.bind(),this.shader.setUniformi(spine.webgl.Shader.SAMPLER,0),this.shader.setUniform4x4f(spine.webgl.Shader.MVP_MATRIX,this.mvp.values),this.batcher.begin(this.shader),this.skeletonRenderer.premultipliedAlpha=d,this.skeletonRenderer.draw(this.batcher,b.skeleton),this.batcher.end(),this.shader.unbind(),a.SpinePlugin.DEBUG&&(this.debugShader.bind(),this.debugShader.setUniform4x4f(spine.webgl.Shader.MVP_MATRIX,this.mvp.values),this.debugRenderer.premultipliedAlpha=d,this.shapes.begin(this.debugShader),this.debugRenderer.draw(this.shapes,b.skeleton),this.shapes.end(),this.debugShader.unbind()),c.blendModeManager.currentBlendMode=-1,c.blendModeManager.setBlendMode(e),c.gl.enable(c.gl.BLEND),c.shaderManager._currentId=null,c.shaderManager.setShader(f),c.spriteBatch.dirty=!0,["2.7.3","2.7.4","2.7.5","2.7.6","2.7.7"].indexOf(Phaser.VERSION)>-1&&c.spriteBatch.sprites.map(function(a){a.texture&&a.texture.baseTexture&&(a.texture.baseTexture._dirty[c.spriteBatch.gl.id]=!0)}),c.drawCount++},b}();b.Renderer=c}(b=a.WebGL||(a.WebGL={}))}(PhaserSpine||(PhaserSpine={}));var PhaserSpine;!function(a){var b;!function(a){var b=function(a){function b(b,c,d){void 0===d&&(d=!1);var e=a.call(this,c)||this;return e.texture=null,e.boundUnit=0,e.useMipMaps=!1,e.context=b instanceof spine.webgl.ManagedWebGLRenderingContext?b:new spine.webgl.ManagedWebGLRenderingContext(b),e.useMipMaps=d,e.restore(),e.context.addRestorable(e),e}return __extends(b,a),b.prototype.setFilters=function(a,b){var c=this.context.gl;this.bind(),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,a),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,b)},b.prototype.setWraps=function(a,b){var c=this.context.gl;this.bind(),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,a),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,b)},b.prototype.update=function(a){var b=this.context.gl;this.texture||(this.texture=this.context.gl.createTexture()),this.bind(),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,this._image),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,a?b.LINEAR_MIPMAP_LINEAR:b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),a&&b.generateMipmap(b.TEXTURE_2D)},b.prototype.restore=function(){this.texture=null,this.update(this.useMipMaps)},b.prototype.bind=function(a){void 0===a&&(a=0);var b=this.context.gl;this.boundUnit=a,b.activeTexture(b.TEXTURE0+a),b.bindTexture(b.TEXTURE_2D,this.texture)},b.prototype.unbind=function(){var a=this.context.gl;a.activeTexture(a.TEXTURE0+this.boundUnit),a.bindTexture(a.TEXTURE_2D,null)},b.prototype.dispose=function(){this.context.removeRestorable(this);var a=this.context.gl;a.deleteTexture(this.texture)},b}(spine.Texture);a.Texture=b}(b=a.WebGL||(a.WebGL={}))}(PhaserSpine||(PhaserSpine={}));